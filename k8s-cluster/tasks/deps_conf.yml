---
- name: create the 'k8s' user
  user: name=k8s append=yes state=present createhome=yes shell=/bin/bash

- name: iterate through members of group
  debug:
    msg: "{{ item }}"
  loop: "{{ groups['your_group_name'] }}"
  
- name: allow 'k8s' to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    line: 'k8s ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'

- name: Update and upgrade apt packages
  become: true
  apt:
    update_cache: yes
    upgrade: 'yes'

# - name: Remove swapfile from /etc/fstab
#   mount:
#     name: "{{ item }}"
#     fstype: swap
#     state: absent
#   with_items:
#     - swap
#     - none



- name: Install packages that allow apt to be used over HTTPS
  apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
  vars:
    packages:
    - apt-transport-https
    - ca-certificates
    - curl
    - gnupg-agent
    - software-properties-common

- name: Add an apt signing key for Docker
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add apt repository for stable version
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
    state: present

- name: Install docker and its dependecies
  apt: 
    name: "{{ packages }}"
    state: present
    update_cache: yes
  vars:
    packages:
    - docker-ce 
    - docker-ce-cli 
    - containerd.io

- name: Add an apt signing key for Kubernetes
  become: yes
  shell: wget https://packages.cloud.google.com/apt/doc/apt-key.gpg && apt-key add apt-key.gpg



- name: Adding apt repository for Kubernetes
  apt_repository:
    repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
    state: present
    filename: kubernetes.list

- name: Install Kubernetes binaries
  apt: 
    name: "{{ packages }}"
    state: present
    update_cache: yes
  vars:
    packages:
      - kubelet 
      - kubeadm 
      - kubectl

- name: Disable SWAP since kubernetes can't work with swap enabled (1/2)
  shell: |
    swapoff -a

- name: Disable SWAP in fstab since kubernetes can't work with swap enabled (2/2)
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
    replace: '# \1'


- name: Create a directory for kubelet if it does not exist
  ansible.builtin.file:
    path: /etc/systemd/system/kubelet.service.d/
    state: directory
    mode: '0755'

- name: Create a directory for static ip address if it does not exist
  ansible.builtin.file:
    path: /etc/network/interfaces.d/
    state: directory
    mode: '0755'

# - name: Creating a file with static network content
#   copy:
#     dest: "/etc/network/interfaces.d/60-floating-ip.cfg"
#     content: |
#       auto eth0:1
#       iface eth0:1 inet static
#         address {{ float_ip_addr }}
#         netmask 32
    
- name: Creating a file with content
  copy:
    dest: "/etc/systemd/system/kubelet.service.d/20-hetzner-cloud.conf"
    content: |
      [Service]
      Environment="KUBELET_EXTRA_ARGS=--cloud-provider=external"

- name: Create a directory for kubelet if it does not exist
  ansible.builtin.file:
    path: /etc/systemd/system/docker.service.d/
    state: directory
    mode: '0755'

- name: Creating a file with content
  copy:
    dest: "/etc/systemd/system/docker.service.d/00-cgroup-systemd.conf"
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd

- name: Reload service daemon-reload
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Restart kubelet
  service:
    name: kubelet
    daemon_reload: yes
    state: restarted